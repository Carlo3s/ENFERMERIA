<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Valoraciones</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .category-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-bottom: 20px;
        }
        .category {
            width: 120px;
            text-align: center;
            cursor: pointer;
        }
        .category img {
            width: 100px;
            height: 100px;
        }
        .category p {
            margin: 5px 0;
            font-size: 14px;
        }
        .category .circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            top: -60px;
            left: 40px;
        }
        .valoracion {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0;
            background-color: white;
            border-radius: 5px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
        .historial-list {
            margin-top: 20px;
            text-align: left;
            display: none;
            max-width: 800px;
            margin: 20px auto;
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">
            <a href="index.html"><img src="logo.png" alt="Logo" id="logo"></a>
        </div>
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="historial.html">Historial</a></li>
            <li><a href="acerca.html">Acerca de</a></li>
            <li><a href="contacto.html">Contacto</a></li>
            <li><a href="Valoracion_preguntas.html">Entrevista</a></li>
            <li><a href="ayuda.html">Recursos</a></li>
            <li><button id="logout">Cerrar Sesi칩n</button></li>
        </ul>
    </nav>
    
    <div class="container">
        <h2>Historial de Valoraciones</h2>
        <div id="historial">
            <div class="category-grid">
                <div class="category" onclick="showHistorial('游댯 Por debajo del peso normal')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #00f;"></div>
                    <p>Por debajo del peso normal</p>
                </div>
                <div class="category" onclick="showHistorial('游릭 Peso saludable')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #0f0;"></div>
                    <p>Peso saludable</p>
                </div>
                <div class="category" onclick="showHistorial('游 Sobrepeso')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #ffa500;"></div>
                    <p>Sobrepeso</p>
                </div>
                <div class="category" onclick="showHistorial('游댮 Obesidad I')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #f00;"></div>
                    <p>Obesidad I</p>
                </div>
                <div class="category" onclick="showHistorial('游릮 Obesidad II')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #800080;"></div>
                    <p>Obesidad II</p>
                </div>
                <div class="category" onclick="showHistorial('游릵 Obesidad III')">
                    <img src="carpeta.png" alt="Carpeta">
                    <div class="circle" style="background-color: #4b0082;"></div>
                    <p>Obesidad III</p>
                </div>
            </div>
            <div class="historial-list" id="historial-list">
                <h3 id="historial-title"></h3>
                <div id="historial-items"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyC2_Bftp6pPmQT41MyYMSc6PiYxEAkz9hs",
            authDomain: "valoracion-enfermeria.firebaseapp.com",
            projectId: "valoracion-enfermeria",
            storageBucket: "valoracion-enfermeria.appspot.com",
            messagingSenderId: "368639381830",
            appId: "1:368639381830:web:253168bfdc4031a9c95547",
            measurementId: "G-YNKHWHMKGB"
        };
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        let historialData = [];

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                cargarHistorial();
            }
        });
    
        document.getElementById("logout").addEventListener("click", () => {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("Error al cerrar sesi칩n: ", error);
            });
        });

        async function cargarHistorial() {
            try {
                const querySnapshot = await getDocs(collection(db, "valoraciones"));
                historialData = [];

                querySnapshot.forEach((doc) => {
                    historialData.push(doc.data());
                });

                if (historialData.length === 0) {
                    document.getElementById("historial-items").innerHTML = "<p>No hay valoraciones guardadas.</p>";
                }
            } catch (error) {
                console.error("Error al cargar historial: ", error);
                document.getElementById("historial-items").innerHTML = "<p>Error al cargar el historial.</p>";
            }
        }

        function showHistorial(semaforo) {
            const historialList = document.getElementById("historial-list");
            const historialTitle = document.getElementById("historial-title");
            const historialItems = document.getElementById("historial-items");

            historialList.style.display = "block";
            historialTitle.textContent = `Historiales - ${semaforo.split(" ").slice(1).join(" ")}`;
            historialItems.innerHTML = "";

            const items = historialData.filter(item => item.semaforo === semaforo);
            if (items.length === 0) {
                historialItems.innerHTML = "<p>No hay historiales disponibles para esta categor칤a.</p>";
            } else {
                // Bot칩n para descargar PDF de esta categor칤a
                const downloadButton = document.createElement("button");
                downloadButton.textContent = `Descargar PDF (${semaforo.split(" ").slice(1).join(" ")})`;
                downloadButton.onclick = () => exportarPDF(items, semaforo.split(" ").slice(1).join(" "));
                historialItems.appendChild(downloadButton);

                // Mostrar las valoraciones de esta categor칤a
                items.forEach((item, index) => {
                    const div = document.createElement("div");
                    div.classList.add("valoracion");
                    div.innerHTML = `
                        <h4>Valoraci칩n ${index + 1}</h4>
                        <p><strong>Paciente:</strong> ${item.paciente}</p>
                        <p><strong>Resultado:</strong> ${item.semaforo}</p>
                        <p><strong>IMC:</strong> ${item.imc || 'No calculado'}</p>
                        <p><strong>PAM:</strong> ${item.pam || 'No calculado'} mmHg</p>
                    `;
                    historialItems.appendChild(div);
                });
            }
        }

        async function exportarPDF(items, categoryName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;

            doc.setFontSize(16);
            doc.text(`Historial de Valoraciones - ${categoryName}`, 10, y);
            y += 10;

            items.forEach((item, index) => {
                doc.setFontSize(12);
                doc.text(`Valoraci칩n ${index + 1}`, 10, y);
                y += 5;
                doc.text(`Paciente: ${item.paciente}`, 10, y);
                y += 5;
                doc.text(`Resultado: ${item.semaforo}`, 10, y);
                y += 5;
                doc.text(`IMC: ${item.imc || 'No calculado'}`, 10, y);
                y += 5;
                doc.text(`PAM: ${item.pam || 'No calculado'} mmHg`, 10, y);
                y += 5;

                doc.text("Datos de Identificaci칩n:", 10, y);
                y += 5;
                doc.text(`Nombre: ${item.nombre}`, 10, y);
                y += 5;
                doc.text(`Edad: ${item.edad}`, 10, y);
                y += 5;
                doc.text(`Sexo: ${item.sexo}`, 10, y);
                y += 5;
                doc.text(`Peso: ${item.peso} kg`, 10, y);
                y += 5;
                doc.text(`Altura: ${item.altura} m`, 10, y);
                y += 5;
                doc.text(`Presi칩n Sist칩lica: ${item.ps || 'No ingresado'} mmHg`, 10, y);
                y += 5;
                doc.text(`Presi칩n Diast칩lica: ${item.pd || 'No ingresado'} mmHg`, 10, y);
                y += 5;

                doc.text("Modo Fisiol칩gico:", 10, y);
                y += 5;
                doc.text("Necesidad de Oxigenaci칩n:", 10, y);
                y += 5;
                doc.text(`쮿a tenido cambios en su respiraci칩n? ${item.cambios_respiracion || 'No contestado'}`, 10, y);
                y += 5;
                if (item.cambios_respiracion_detalle) {
                    doc.text(`Especificar: ${item.cambios_respiracion_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`Problemas respiratorios (6 meses): ${item.problemas_respiratorios || '0'}`, 10, y);
                y += 5;
                doc.text(`쯊oma medicamentos para problemas respiratorios? ${item.medicamentos_respiratorios || 'No contestado'}`, 10, y);
                y += 5;
                if (item.medicamentos_detalle) {
                    doc.text(`Especificar: ${item.medicamentos_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`쮽uma? ${item.fuma || 'No contestado'}`, 10, y);
                y += 5;
                if (item.cigarrillos_dia) {
                    doc.text(`Cigarrillos al d칤a: ${item.cigarrillos_dia}`, 10, y);
                    y += 5;
                }
                if (item.fuma_historia) {
                    doc.text(`쮿a consumido tabaco alguna vez? ${item.fuma_historia}`, 10, y);
                    y += 5;
                }
                doc.text(`쮿umo o contaminantes en su ambiente? ${item.humo_ambiente || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮽amiliares con problemas respiratorios? ${item.antecedentes_respiratorios || 'No contestado'}`, 10, y);
                y += 5;
                if (item.antecedentes_detalle) {
                    doc.text(`Especificar: ${item.antecedentes_detalle}`, 10, y);
                    y += 5;
                }

                doc.text("Necesidad de Nutrici칩n:", 10, y);
                y += 5;
                doc.text(`Alimentos que consume: ${item.alimentos_hogar || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺onsume suplementos? ${item.suplementos || 'No contestado'}`, 10, y);
                y += 5;
                if (item.suplementos_detalle) {
                    doc.text(`쮺u치les? ${item.suplementos_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`Comidas al d칤a: ${item.comidas_dia || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쯇roblemas para comer? ${item.problemas_comer || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Necesidad de Eliminaci칩n:", 10, y);
                y += 5;
                doc.text(`Frecuencia de orina (24 hrs): ${item.frecuencia_orina || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺ambio en patr칩n de orina? ${item.cambio_orina || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Frecuencia de evacuaci칩n (24 hrs): ${item.frecuencia_evacuacion || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺ambio en patr칩n de evacuaci칩n? ${item.cambio_evacuacion || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Necesidad de Actividad y Reposo:", 10, y);
                y += 5;
                doc.text(`Actividades diarias: ${item.actividades_diarias || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Horas de sue침o (24 hrs): ${item.horas_sueno || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺onsume alcohol? ${item.consume_alcohol || 'No contestado'}`, 10, y);
                y += 5;
                if (item.frecuencia_alcohol) {
                    doc.text(`Frecuencia: ${item.frecuencia_alcohol}`, 10, y);
                    y += 5;
                }
                doc.text(`Realiza ejercicio? ${item.ejercicio || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Modo Autoconcepto:", 10, y);
                y += 5;
                doc.text(`쯉칠 qui칠n soy? ${item.se_quien_soy || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺칩mo te sientes f칤sicamente? ${item.sentimiento_fisico || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺칩mo te describes? ${item.descripcion_personal || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Creencias espirituales: ${item.creencias?.join(", ") || 'No contestado'}`, 10, y);
                y += 5;
                if (item.creencias_otros) {
                    doc.text(`Otros: ${item.creencias_otros}`, 10, y);
                    y += 5;
                }

                doc.text("Modo Rol:", 10, y);
                y += 5;
                doc.text(`Roles: ${item.roles?.join(", ") || 'No contestado'}`, 10, y);
                y += 5;
                if (item.roles_otro) {
                    doc.text(`Otro: ${item.roles_otro}`, 10, y);
                    y += 5;
                }
                doc.text(`Afectaci칩n del rol de paciente: ${item.afectacion_rol || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Modo Interdependencia:", 10, y);
                y += 5;
                doc.text(`Seres significativos:`, 10, y);
                y += 5;
                doc.text(`1. ${item.significativos_1 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`2. ${item.significativos_2 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`3. ${item.significativos_3 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Red de apoyo: ${item.red_apoyo || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Relaci칩n con estas personas: ${item.relacion_personas || 'No contestado'}`, 10, y);
                y += 10;

                if (y > 270) {
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save(`valoraciones_${categoryName.toLowerCase().replace(/ /g, "_")}.pdf`);
        }
    </script>
</body>
</html>