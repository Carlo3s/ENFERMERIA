<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Valoraciones</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        .category {
            margin-bottom: 20px;
        }
        .category h3 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .valoracion {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 0;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <nav>
        <div class="logo">
            <a href="index.html"><img src="logo.png" alt="Logo" id="logo"></a>
        </div>
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="historial.html">Historial</a></li>
            <li><a href="acerca.html">Acerca de</a></li>
            <li><a href="contacto.html">Contacto</a></li>
            <li><a href="Valoracion_preguntas.html">Entrevista</a></li>
            <li><a href="ayuda.html">Recursos</a></li>
            <li><button id="logout">Cerrar Sesi칩n</button></li>
        </ul>
    </nav>
    
    <div class="container">
        <h2>Historial de Valoraciones</h2>
        <div id="historial"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";
    
        const firebaseConfig = {
            apiKey: "AIzaSyC2_Bftp6pPmQT41MyYMSc6PiYxEAkz9hs",
            authDomain: "valoracion-enfermeria.firebaseapp.com",
            projectId: "valoracion-enfermeria",
            storageBucket: "valoracion-enfermeria.appspot.com",
            messagingSenderId: "368639381830",
            appId: "1:368639381830:web:253168bfdc4031a9c95547",
            measurementId: "G-YNKHWHMKGB"
        };
    
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
    
        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                mostrarHistorial();
            }
        });
    
        document.getElementById("logout").addEventListener("click", () => {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("Error al cerrar sesi칩n: ", error);
            });
        });

        async function mostrarHistorial() {
            const historialDiv = document.getElementById("historial");
            try {
                const querySnapshot = await getDocs(collection(db, "valoraciones"));
                const historial = [];

                querySnapshot.forEach((doc) => {
                    historial.push(doc.data());
                });

                if (historial.length === 0) {
                    historialDiv.innerHTML = "<p>No hay valoraciones guardadas.</p>";
                    return;
                }

                // Agrupar valoraciones por clasificaci칩n
                const categorias = {
                    "游댯 Por debajo del peso normal": [],
                    "游릭 Peso saludable": [],
                    "游 Sobrepeso": [],
                    "游댮 Obesidad I": [],
                    "游릮 Obesidad II": [],
                    "游릵 Obesidad III": []
                };

                historial.forEach((item) => {
                    const semaforo = item.semaforo || "No clasificado";
                    if (categorias[semaforo]) {
                        categorias[semaforo].push(item);
                    }
                });

                // Mostrar cada categor칤a como una secci칩n
                for (const [semaforo, items] of Object.entries(categorias)) {
                    if (items.length === 0) continue; // Saltar categor칤as vac칤as

                    const categoryDiv = document.createElement("div");
                    categoryDiv.classList.add("category");

                    // Extraer el nombre de la categor칤a (sin el emoji)
                    const categoryName = semaforo.split(" ").slice(1).join(" ");

                    // T칤tulo de la categor칤a con el emoji
                    const h3 = document.createElement("h3");
                    h3.innerHTML = `${semaforo}`;
                    categoryDiv.appendChild(h3);

                    // Bot칩n para descargar PDF de esta categor칤a
                    const downloadButton = document.createElement("button");
                    downloadButton.textContent = `Descargar PDF (${categoryName})`;
                    downloadButton.onclick = () => exportarPDF(items, categoryName);
                    categoryDiv.appendChild(downloadButton);

                    // Mostrar las valoraciones de esta categor칤a
                    items.forEach((item, index) => {
                        const div = document.createElement("div");
                        div.classList.add("valoracion");
                        div.innerHTML = `
                            <h4>Valoraci칩n ${index + 1}</h4>
                            <p>Paciente: ${item.paciente}</p>
                            <p>Resultado: ${item.semaforo}</p>
                            <p>IMC: ${item.imc || 'No calculado'}</p>
                            <p>PAM: ${item.pam || 'No calculado'} mmHg</p>
                        `;
                        categoryDiv.appendChild(div);
                    });

                    historialDiv.appendChild(categoryDiv);
                }
            } catch (error) {
                console.error("Error al cargar historial: ", error);
                historialDiv.innerHTML = "<p>Error al cargar el historial.</p>";
            }
        }

        async function exportarPDF(items, categoryName) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 10;

            doc.setFontSize(16);
            doc.text(`Historial de Valoraciones - ${categoryName}`, 10, y);
            y += 10;

            items.forEach((item, index) => {
                doc.setFontSize(12);
                doc.text(`Valoraci칩n ${index + 1}`, 10, y);
                y += 5;
                doc.text(`Paciente: ${item.paciente}`, 10, y);
                y += 5;
                doc.text(`Resultado: ${item.semaforo}`, 10, y);
                y += 5;
                doc.text(`IMC: ${item.imc || 'No calculado'}`, 10, y);
                y += 5;
                doc.text(`PAM: ${item.pam || 'No calculado'} mmHg`, 10, y);
                y += 5;

                doc.text("Datos de Identificaci칩n:", 10, y);
                y += 5;
                doc.text(`Nombre: ${item.nombre}`, 10, y);
                y += 5;
                doc.text(`Edad: ${item.edad}`, 10, y);
                y += 5;
                doc.text(`Sexo: ${item.sexo}`, 10, y);
                y += 5;
                doc.text(`Peso: ${item.peso} kg`, 10, y);
                y += 5;
                doc.text(`Altura: ${item.altura} m`, 10, y);
                y += 5;
                doc.text(`Presi칩n Sist칩lica: ${item.ps || 'No ingresado'} mmHg`, 10, y);
                y += 5;
                doc.text(`Presi칩n Diast칩lica: ${item.pd || 'No ingresado'} mmHg`, 10, y);
                y += 5;

                doc.text("Modo Fisiol칩gico:", 10, y);
                y += 5;
                doc.text("Necesidad de Oxigenaci칩n:", 10, y);
                y += 5;
                doc.text(`쮿a tenido cambios en su respiraci칩n? ${item.cambios_respiracion || 'No contestado'}`, 10, y);
                y += 5;
                if (item.cambios_respiracion_detalle) {
                    doc.text(`Especificar: ${item.cambios_respiracion_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`Problemas respiratorios (6 meses): ${item.problemas_respiratorios || '0'}`, 10, y);
                y += 5;
                doc.text(`쯊oma medicamentos para problemas respiratorios? ${item.medicamentos_respiratorios || 'No contestado'}`, 10, y);
                y += 5;
                if (item.medicamentos_detalle) {
                    doc.text(`Especificar: ${item.medicamentos_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`쮽uma? ${item.fuma || 'No contestado'}`, 10, y);
                y += 5;
                if (item.cigarrillos_dia) {
                    doc.text(`Cigarrillos al d칤a: ${item.cigarrillos_dia}`, 10, y);
                    y += 5;
                }
                if (item.fuma_historia) {
                    doc.text(`쮿a consumido tabaco alguna vez? ${item.fuma_historia}`, 10, y);
                    y += 5;
                }
                doc.text(`쮿umo o contaminantes en su ambiente? ${item.humo_ambiente || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮽amiliares con problemas respiratorios? ${item.antecedentes_respiratorios || 'No contestado'}`, 10, y);
                y += 5;
                if (item.antecedentes_detalle) {
                    doc.text(`Especificar: ${item.antecedentes_detalle}`, 10, y);
                    y += 5;
                }

                doc.text("Necesidad de Nutrici칩n:", 10, y);
                y += 5;
                doc.text(`Alimentos que consume: ${item.alimentos_hogar || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺onsume suplementos? ${item.suplementos || 'No contestado'}`, 10, y);
                y += 5;
                if (item.suplementos_detalle) {
                    doc.text(`쮺u치les? ${item.suplementos_detalle}`, 10, y);
                    y += 5;
                }
                doc.text(`Comidas al d칤a: ${item.comidas_dia || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쯇roblemas para comer? ${item.problemas_comer || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Necesidad de Eliminaci칩n:", 10, y);
                y += 5;
                doc.text(`Frecuencia de orina (24 hrs): ${item.frecuencia_orina || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺ambio en patr칩n de orina? ${item.cambio_orina || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Frecuencia de evacuaci칩n (24 hrs): ${item.frecuencia_evacuacion || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺ambio en patr칩n de evacuaci칩n? ${item.cambio_evacuacion || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Necesidad de Actividad y Reposo:", 10, y);
                y += 5;
                doc.text(`Actividades diarias: ${item.actividades_diarias || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Horas de sue침o (24 hrs): ${item.horas_sueno || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺onsume alcohol? ${item.consume_alcohol || 'No contestado'}`, 10, y);
                y += 5;
                if (item.frecuencia_alcohol) {
                    doc.text(`Frecuencia: ${item.frecuencia_alcohol}`, 10, y);
                    y += 5;
                }
                doc.text(`Realiza ejercicio? ${item.ejercicio || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Modo Autoconcepto:", 10, y);
                y += 5;
                doc.text(`쯉칠 qui칠n soy? ${item.se_quien_soy || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺칩mo te sientes f칤sicamente? ${item.sentimiento_fisico || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`쮺칩mo te describes? ${item.descripcion_personal || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Creencias espirituales: ${item.creencias?.join(", ") || 'No contestado'}`, 10, y);
                y += 5;
                if (item.creencias_otros) {
                    doc.text(`Otros: ${item.creencias_otros}`, 10, y);
                    y += 5;
                }

                doc.text("Modo Rol:", 10, y);
                y += 5;
                doc.text(`Roles: ${item.roles?.join(", ") || 'No contestado'}`, 10, y);
                y += 5;
                if (item.roles_otro) {
                    doc.text(`Otro: ${item.roles_otro}`, 10, y);
                    y += 5;
                }
                doc.text(`Afectaci칩n del rol de paciente: ${item.afectacion_rol || 'No contestado'}`, 10, y);
                y += 5;

                doc.text("Modo Interdependencia:", 10, y);
                y += 5;
                doc.text(`Seres significativos:`, 10, y);
                y += 5;
                doc.text(`1. ${item.significativos_1 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`2. ${item.significativos_2 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`3. ${item.significativos_3 || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Red de apoyo: ${item.red_apoyo || 'No contestado'}`, 10, y);
                y += 5;
                doc.text(`Relaci칩n con estas personas: ${item.relacion_personas || 'No contestado'}`, 10, y);
                y += 10;

                if (y > 270) {
                    doc.addPage();
                    y = 10;
                }
            });

            doc.save(`valoraciones_${categoryName.toLowerCase().replace(/ /g, "_")}.pdf`);
        }
    </script>
</body>
</html>