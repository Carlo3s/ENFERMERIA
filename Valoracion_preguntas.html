<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrevista - Valoración</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav>
        <div class="logo">
            <a href="index.html"><img src="logo.png" alt="Logo" id="logo"></a>
        </div>
        <ul>
            <li><a href="index.html">Inicio</a></li>
            <li><a href="historial.html">Historial</a></li>
            <li><a href="acerca.html">Acerca de</a></li>
            <li><a href="contacto.html">Contacto</a></li>
            <li><a href="Valoracion_preguntas.html">Entrevista</a></li>
            <li><button id="logout" style="cursor:pointer; background:none; border:none; color:white; font-size:16px;">Cerrar Sesión</button></li>
        </ul>
    </nav>

    <h1>Guía de Valoración - Modelo de Adaptación de Roy</h1>
    <form id="assessmentForm">
        <details open id="identificacion">
            <summary>Datos de Identificación</summary>
            <div class="question"><label>Nombre: <input type="text" name="nombre" required></label></div>
            <div class="question"><label>Edad: <input type="number" name="edad" min="0" required></label></div>
            <div class="question"><label>Sexo: 
                <select name="sexo" required>
                    <option value="">Seleccione</option>
                    <option value="M">Masculino</option>
                    <option value="F">Femenino</option>
                </select></label></div>
            <div class="question"><label>Peso (kg): <input type="number" name="peso"></label></div>
            <div class="question"><label>Altura (m): <input type="number" step="0.01" name="altura"></label></div>
            <div class="question"><label>Presión Sistólica: <input type="number" name="ps"></label></div>
            <div class="question"><label>Presión Diastólica: <input type="number" name="pd"></label></div>
        </details>
        <!-- Agrega aquí las otras secciones (Modo Fisiológico, Autoconcepto, etc.) como en respuestas anteriores -->
        <button type="submit">Enviar</button>
    </form>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2_Bftp6pPmQT41MyYMSc6PiYxEAkz9hs",
            authDomain: "valoracion-enfermeria.firebaseapp.com",
            projectId: "valoracion-enfermeria",
            storageBucket: "valoracion-enfermeria.appspot.com",
            messagingSenderId: "368639381830",
            appId: "1:368639381830:web:253168bfdc4031a9c95547",
            measurementId: "G-YNKHWHMKGB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = "login.html";
            }
        });

        document.getElementById("logout").addEventListener("click", () => {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            }).catch((error) => {
                console.error("Error al cerrar sesión: ", error);
            });
        });

        const form = document.getElementById('assessmentForm');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("Debes iniciar sesión para enviar el formulario.");
                return;
            }

            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            // Calcular IMC y PAM si se proporcionan los datos
            if (data.peso && data.altura) {
                data.imc = (data.peso / (data.altura * data.altura)).toFixed(2);
            }
            if (data.ps && data.pd) {
                data.pam = (((2 * parseInt(data.pd)) + parseInt(data.ps)) / 3).toFixed(2);
            }

            try {
                await addDoc(collection(db, `users/${user.uid}/valoraciones`), {
                    ...data,
                    timestamp: new Date().toISOString()
                });
                alert("Valoración enviada con éxito.");
                form.reset();
                window.location.href = "historial.html";
            } catch (error) {
                console.error("Error al enviar valoración:", error);
                alert("Error al enviar la valoración.");
            }
        });
    </script>
    <script src="script.js" defer></script>
</body>
</html>